schema_version: "0.1"

id: "nanoclaw.scheduler.daily-digest.timeout-recovery"
title: "Scheduled digest recovers from a web_fetch timeout and sends one outbound message"
description: "Shows scheduler-path recovery behavior using current core assertions (retry via repeated web_fetch call, then successful outbound send)."

adapter: "nanoclaw"
mode: "replay"
tags:
  - "nanoclaw"
  - "scheduler"
  - "recovery"
  - "regression"

adapter_input:
  replay_file: "./replay.json"

scenario:
  group_id: "group-ops"
  session_id: "sched-sess-002"
  trigger: "scheduler"
  scheduler_context:
    task_id: "task-daily-digest"
    task_name: "Daily AI Digest"
    scheduled_for: "2026-02-25T09:00:00-08:00"
    timezone: "America/Los_Angeles"
  input_messages: []
  prior_messages: []

tools:
  available:
    - "web_search"
    - "web_fetch"
    - "outbound_send"
  fixtures:
    - id: "fx.web_search.daily_ai_digest"
      tool: "web_search"
      description: "Daily search result set"
    - id: "fx.web_fetch.timeout_once"
      tool: "web_fetch"
      description: "First web_fetch attempt times out"
    - id: "fx.web_fetch.eval_article"
      tool: "web_fetch"
      description: "Second web_fetch attempt succeeds"
    - id: "fx.outbound_send.success"
      tool: "outbound_send"
      description: "Outbound message delivery success"

assertions:
  - id: "scheduler-task-context-present"
    type: "scheduler_task_runs"
    severity: "critical"
    params:
      task_id: "task-daily-digest"

  - id: "uses-search"
    type: "must_call_tool"
    severity: "critical"
    params:
      tool: "web_search"

  - id: "fetch-retried-at-most-twice"
    type: "max_tool_calls"
    severity: "critical"
    params:
      tool: "web_fetch"
      max: 2

  - id: "retry-policy-timeout-once"
    type: "retry_policy_respected"
    severity: "critical"
    params:
      tool: "web_fetch"
      max_retries: 1
      retry_on_error_types:
        - "timeout"

  - id: "sends-outbound-message"
    type: "must_call_tool"
    severity: "critical"
    params:
      tool: "outbound_send"

  - id: "search-before-send"
    type: "tool_call_order"
    severity: "critical"
    params:
      before:
        event_type: "tool_call"
        tool: "web_search"
      after:
        event_type: "tool_call"
        tool: "outbound_send"

  - id: "single-send"
    type: "max_tool_calls"
    severity: "critical"
    params:
      tool: "outbound_send"
      max: 1

  - id: "single-send-scheduler-count"
    type: "scheduler_outbound_count"
    severity: "critical"
    params:
      exact: 1

  - id: "stop-after-send-success"
    type: "stop_after_success"
    severity: "warning"
    params:
      success_event:
        event_type: "tool_result"
        tool: "outbound_send"
        success: true
      forbid_following:
        event_type: "tool_call"

  - id: "grounded-summary"
    type: "claims_supported_by_fixtures"
    severity: "critical"
    params:
      allowed_sources:
        - "web_search"
        - "web_fetch"

  - id: "digest-format-bullets"
    type: "output_matches_format"
    severity: "warning"
    params:
      format: "bullet_list"
      min_bullets: 1

expected:
  outcome: "Scheduled task tolerates one web_fetch timeout, retries, and sends one grounded digest."
  failure_categories:
    - "scheduler execution failure"
    - "recovery failure"
    - "duplicate outbound messages"

reporting:
  save_trace: true
